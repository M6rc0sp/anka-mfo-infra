# ğŸ“ Arquitetura do Anka MFO

## VisÃ£o em Camadas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT LAYER (Browser)                         â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚         Next.js Frontend (React SPA)                         â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚  â”‚  Pages:                                                â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ /dashboard        - VisÃ£o geral                     â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ /projections      - ProjeÃ§Ãµes detalhadas            â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ /allocations      - AlocaÃ§Ã£o de ativos              â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ /history          - HistÃ³rico de versÃµes            â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ /auth/*           - AutenticaÃ§Ã£o                    â”‚  â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                    â†“ HTTP/REST + JSON                        â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚  â”‚  Components & Hooks:                                   â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ React Query (useQuery, useMutation)                 â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ Context API (Auth, Client Selection)                â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ Charts (Recharts)                                   â”‚  â”‚ â”‚
â”‚   â”‚  â”‚  â€¢ Forms (React Hook Form)                             â”‚  â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APPLICATION LAYER (API Server - Port 3333)             â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚              Fastify (Node.js Web Server)                    â”‚ â”‚
â”‚   â”‚  â€¢ Health Checks           â€¢ CORS                           â”‚ â”‚
â”‚   â”‚  â€¢ Error Handling          â€¢ Validation (Zod)               â”‚ â”‚
â”‚   â”‚  â€¢ Logging                 â€¢ Request/Response               â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â†“                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚                    Controllers Layer                         â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚   â”‚  â”‚ ClientCtrl   â”‚  â”‚  SimCtrl     â”‚  â”‚  AllocCtrl   â”‚ ...   â”‚ â”‚
â”‚   â”‚  â”‚ (POST/GET)   â”‚  â”‚ (CRUD)       â”‚  â”‚ (CRUD)       â”‚       â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚   â”‚         â†“                  â†“                 â†“                â”‚ â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚   â”‚                    Services Layer                            â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚   â”‚  â”‚ ClientServiceâ”‚  â”‚ SimService   â”‚  â”‚ AllocService â”‚ ...   â”‚ â”‚
â”‚   â”‚  â”‚ â€¢ Validate   â”‚  â”‚ â€¢ Calculate  â”‚  â”‚ â€¢ Validate   â”‚       â”‚ â”‚
â”‚   â”‚  â”‚ â€¢ Persist    â”‚  â”‚ â€¢ Orchestrateâ”‚  â”‚ â€¢ Persist    â”‚       â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚   â”‚         â†“                  â†“                 â†“                â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚   â”‚   â”‚ Projection Engine (Motor)          â”‚                     â”‚ â”‚
â”‚   â”‚   â”‚ â€¢ Monthly calculations              â”‚                     â”‚ â”‚
â”‚   â”‚   â”‚ â€¢ Tax adjustments                   â”‚                     â”‚ â”‚
â”‚   â”‚   â”‚ â€¢ Life status handling              â”‚                     â”‚ â”‚
â”‚   â”‚   â”‚ â€¢ Insurance integration             â”‚                     â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚   â”‚         â†“                  â†“                 â†“                â”‚ â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚   â”‚              Repository/DAO Layer                            â”‚ â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚   â”‚  â”‚ClientRepository   â”‚SimRepository â”‚AllocRepositoryâ”‚ ...   â”‚ â”‚
â”‚   â”‚  â”‚ â€¢ find()     â”‚  â”‚ â€¢ save()     â”‚  â”‚ â€¢ delete()   â”‚       â”‚ â”‚
â”‚   â”‚  â”‚ â€¢ create()   â”‚  â”‚ â€¢ query()    â”‚  â”‚ â€¢ update()   â”‚       â”‚ â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚   â”‚         â†“                  â†“                 â†“                â”‚ â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚   â”‚            Database Access Layer (Drizzle ORM)              â”‚ â”‚
â”‚   â”‚  â€¢ Schema definitions                                       â”‚ â”‚
â”‚   â”‚  â€¢ Type-safe queries                                        â”‚ â”‚
â”‚   â”‚  â€¢ Migrations (se aplicÃ¡vel)                                â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ TCP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DATA LAYER (PostgreSQL Database - Port 5432)               â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚             PostgreSQL 15 Database (anka)                    â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   ENUMS:                                                     â”‚ â”‚
â”‚   â”‚   â€¢ status_de_vida (vivo, falecido, incapacidade)          â”‚ â”‚
â”‚   â”‚   â€¢ tipo_alocacao (financeira, imovel)                      â”‚ â”‚
â”‚   â”‚   â€¢ tipo_movimentacao (aporte, resgate, rendimento, taxa)  â”‚ â”‚
â”‚   â”‚   â€¢ status_simulacao (rascunho, ativa, arquivada)          â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   TABLES:                                                    â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ clients                  (customers/family)         â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)               â””â”€â†’ simulations (FK)      â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ name, email, cpf                                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ phone, birthdate                                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ status (life status)                            â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ simulations        (financial projections)          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ client_id (FK) â†’ clients                         â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ name, description                               â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ initial_capital, monthly_contribution           â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ inflation_rate, years_projection                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ status (draft, active, archived)                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at, updated_at                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚    â”œâ”€â†’ allocations (FK)                            â”‚  â”‚ â”‚
â”‚   â”‚   â”‚    â”œâ”€â†’ insurances (FK)                             â”‚  â”‚ â”‚
â”‚   â”‚   â”‚    â””â”€â†’ simulation_versions (FK)                    â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ allocations        (asset allocation per sim)       â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ simulation_id (FK) â†’ simulations                 â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ type (financial, real estate)                    â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ description, percentage, initial_value           â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ annual_return                                    â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at, updated_at                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚    â””â”€â†’ transactions (FK)                           â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ transactions       (movements/flows)                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ allocation_id (FK) â†’ allocations                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ type (deposit, withdrawal, yield, fee)           â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ amount, description                              â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ transaction_date                                 â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at, updated_at                          â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ insurances         (coverage policies)              â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ simulation_id (FK) â†’ simulations                 â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ type (life, disability, coverage)                â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ coverage_amount, monthly_cost                    â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ start_date, end_date                             â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at, updated_at                          â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ simulation_versions    (version history)            â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ simulation_id (FK) â†’ simulations                 â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ version_number                                   â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ snapshot (JSONB - full state)                    â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at                                       â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚   â”‚   â”‚ users              (authentication) [Phase 8]       â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ id (PK)                                          â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ email (unique)                                   â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ password_hash                                    â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ role (admin, assessor)                           â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â”œâ”€ active                                           â”‚  â”‚ â”‚
â”‚   â”‚   â”‚ â””â”€ created_at, updated_at                          â”‚  â”‚ â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚   â”‚                                                              â”‚ â”‚
â”‚   â”‚   INDEXES:                                                  â”‚ â”‚
â”‚   â”‚   â€¢ idx_clients_email, idx_clients_cpf                     â”‚ â”‚
â”‚   â”‚   â€¢ idx_simulations_client_id, idx_simulations_status      â”‚ â”‚
â”‚   â”‚   â€¢ idx_allocations_simulation_id                          â”‚ â”‚
â”‚   â”‚   â€¢ idx_transactions_allocation_id                         â”‚ â”‚
â”‚   â”‚   â€¢ idx_insurances_simulation_id                           â”‚ â”‚
â”‚   â”‚   â€¢ idx_simulation_versions_simulation_id                  â”‚ â”‚
â”‚   â”‚   â€¢ idx_users_email                                        â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Fluxo de Dados

### 1. Criar SimulaÃ§Ã£o

```
Frontend (Create Form)
    â†“ POST /simulations
Controller â†’ Service â†’ Repository
    â†“ INSERT INTO simulations
PostgreSQL
    â†“ UUID (id da simulaÃ§Ã£o)
Repository â†’ Service â†’ Controller
    â†“ 201 Created + JSON
Frontend (Update List)
```

### 2. Calcular ProjeÃ§Ã£o

```
Frontend (Select Simulation)
    â†“ GET /simulations/{id}/projection
Controller â†’ Service
    â†“ Projection Engine:
       1. Load simulation
       2. Load allocations
       3. Load transactions
       4. Load insurances
       5. Calculate month by month
       6. Apply taxes
       7. Handle life status
       8. Return projections
    â†“
PostgreSQL (Read-only)
    â†“
Projection Engine (In-Memory Calculation)
    â†“
Service â†’ Controller
    â†“ 200 OK + Projection Data
Frontend (Display Charts)
```

### 3. Atualizar AlocaÃ§Ã£o

```
Frontend (Edit Form)
    â†“ PUT /allocations/{id}
Controller â†’ Validate (Zod)
    â†“ Service â†’ Business Logic
    â†“ Repository â†’ UPDATE
PostgreSQL
    â†“ Row Updated
Repository â†’ Service â†’ Controller
    â†“ 200 OK + Updated Data
Frontend (Update UI)
    â†“ React Query Invalidate
    â†“ Re-fetch Data
Frontend (Display Updated)
```

## SeparaÃ§Ã£o de Responsabilidades

### Controllers (src/infra/http/)
- Recebem requisiÃ§Ãµes HTTP
- Validam formato (Zod)
- Chamam Services
- Retornam respostas HTTP
- **NÃƒO** contÃªm lÃ³gica de negÃ³cio

### Services (src/application/)
- Orquestram operaÃ§Ãµes
- ContÃªm lÃ³gica de negÃ³cio
- Chamam Repositories
- Tratam erros
- **NÃƒO** conhecem HTTP

### Repositories (src/infra/repositories/)
- AbstraÃ§Ã£o de acesso a dados
- Implementam interfaces (src/domain/)
- Usam Drizzle ORM
- **NÃƒO** contÃªm lÃ³gica de negÃ³cio

### Domain (src/domain/)
- Entidades (TypeScript classes/interfaces)
- Value Objects
- Interfaces de Repositories
- Tipos de negÃ³cio (ENUMS)
- **Zero** dependÃªncias externas

### Projection Engine (src/application/projection/)
- Motor de cÃ¡lculo
- SimulaÃ§Ãµes mensais
- Ajustes de inflaÃ§Ã£o
- Tratamento de seguros
- ComparaÃ§Ã£o de cenÃ¡rios

## Tecnologias por Camada

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (Next.js 14)                                   â”‚
â”‚ â€¢ React 18                                              â”‚
â”‚ â€¢ React Query v5                                        â”‚
â”‚ â€¢ Recharts                                              â”‚
â”‚ â€¢ shadcn/ui                                             â”‚
â”‚ â€¢ Tailwind CSS                                          â”‚
â”‚ â€¢ React Hook Form                                       â”‚
â”‚ â€¢ Zod (validation)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (Fastify 4)                                     â”‚
â”‚ â€¢ Node.js 20                                            â”‚
â”‚ â€¢ TypeScript 5                                          â”‚
â”‚ â€¢ Fastify (web framework)                               â”‚
â”‚ â€¢ Drizzle ORM                                           â”‚
â”‚ â€¢ Zod (validation)                                      â”‚
â”‚ â€¢ JWT (auth)                                            â”‚
â”‚ â€¢ Vitest (testing)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database (PostgreSQL 15)                                â”‚
â”‚ â€¢ ACID compliance                                       â”‚
â”‚ â€¢ JSONB (flexible data)                                 â”‚
â”‚ â€¢ UUID (primary keys)                                   â”‚
â”‚ â€¢ Enums (type safety)                                   â”‚
â”‚ â€¢ Indexes (performance)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## PadrÃµes de Design

| PadrÃ£o | ImplementaÃ§Ã£o | BenefÃ­cio |
|--------|---------------|-----------|
| **Repository** | AbstraÃ§Ã£o de dados | Testabilidade, flexibilidade |
| **Service** | LÃ³gica centralizada | ReutilizaÃ§Ã£o, testabilidade |
| **Factory** | CriaÃ§Ã£o de entidades | Encapsulamento |
| **Strategy** | Motor de cÃ¡lculo | Flexibilidade de algoritmos |
| **Dependency Injection** | Container de deps | Loose coupling |
| **SOLID** | Aplicado em toda codebase | Manutenibilidade |

## Fluxo de CI/CD (Futuro)

```
Git Push
    â†“
GitHub Actions
    â”œâ”€ Lint (ESLint)
    â”œâ”€ Type Check (TSC)
    â”œâ”€ Tests (Vitest)
    â”œâ”€ Build Backend (Docker)
    â”œâ”€ Build Frontend (Docker)
    â””â”€ Deploy (if main branch)
    
Deploy
    â”œâ”€ Push Docker images
    â”œâ”€ Update docker-compose
    â”œâ”€ Run migrations
    â”œâ”€ Restart containers
    â””â”€ Health checks
```

---

PrÃ³ximo: [INFRAESTRUTURA.md](./INFRAESTRUTURA.md)
